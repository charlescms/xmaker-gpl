{
   Programa.: XECF_Daruma_FS345.Pas
   Copyright: Modular Software 2005
            : Todos os direitos reservados
   Site.....: http://www.xmaker.com.br
}
unit XECF_Daruma_FS345;

interface

{$I Princ.inc}

uses Classes, Sysutils, XECF, Windows;

type
  TECF_Daruma_FS345 = class(TComandos)
  private
    function DecodeErros(Erro, Aviso: Integer): string;
  protected
    function GetLigada: Boolean; override;
  public
    function Executa_Comando(xComando: string; TamanhoRetorno: Integer = 0): Boolean; override;
    function LeituraX(xOperador: String):Boolean; override;
  published
    property Ligada: Boolean read GetLigada;
end;

implementation

function TECF_Daruma_FS345.DecodeErros(Erro,Aviso: Integer): string;
begin
  Result := '';
  case aviso of
    01: Result := 'Near End foi detectado ( Papel perto do fim )';
    02: Result := 'Execute redução Z';
    04: Result := 'Queda de energia';
    10: Result := 'Bateria interna requer substituição';
    20: Result := 'Operação habilitada somente em MIT';
  end;
  case Erro of
    01: Result := 'Comando habilitado somente em modo manutenção';
    02: Result := 'Falha na gravação da Memória Fiscal';
    03: Result := 'Capacidade da Memória Fiscal esgotada';
    04: Result := 'Data fornecida não coincide com a data interna da IF';
    05: Result := 'IF bloqueada por erro fiscal';
    06: Result := 'Erro no campo de controle da Memória Fiscal';
    07: Result := 'Existe uma Memória Fiscal instalada';
    08: Result := 'Senha incorreta';
    09: Result := 'Comando habilitado somente em modo operação';
    10: Result := 'Documento aberto';
    11: Result := 'Documento não aberto';
    12: Result := 'Não há documento a cancelar';
    13: Result := 'Campo numérico com valores inválidos';
    14: Result := 'Capacidade máxima da memória foi atingida';
    15: Result := 'Item solicitado não foi encontrado';
    16: Result := 'Erro na sintaxe do comando';
    17: Result := 'Overflow nos cálculos internos';
    18: Result := 'Alíquota de imposto não definida para o totalizador selecionado';
    19: Result := 'Memória Fiscal vazia';
    20: Result := 'Nenhum campo requer atualização';
    21: Result := 'Repita o comando de Redução Z';
    22: Result := 'Redução Z do dia já executada';
    23: Result := 'Redução Z pendente';
    24: Result := 'Valor de desconto ou acréscimo inválido';
    25: Result := 'Caracteres não estampáveis foram encontrados';
    26: Result := 'Comando não pode ser executado';
    27: Result := 'Operação abortada';
    28: Result := 'Campo numérico em zero não é permitido';
    29: Result := 'Documento anterior não foi Cupom Fiscal';
    30: Result := 'Foi selecionado um documento não fiscal inválido ou não programado';
    31: Result := 'Não pode autenticar';
    32: Result := 'Desconto em ISS não habilitado';
    33: Result := 'Emita Comprovantes NF Vinculados pendentes';
    34: Result := 'IF bloqueada por erro fiscal';
    35: Result := 'Relógio interno inoperante';
    36: Result := 'Versão do firmware gravada na MF não coincide com a esperada';
    38: Result := 'Foi selecionada uma forma de pagamento inválida';
    39: Result := 'Erro na seqüência de fechamento do documento';
    40: Result := 'Já foi emitido algum documento após a última redução Z';
    41: Result := 'Data/hora fornecida é anterior a última gravada na Memória Fiscal';
    42: Result := 'Leitura X do início do dia ainda não foi emitida';
    43: Result := 'Não pode mais emitir CNF Vinculado solicitado';
    44: Result := 'Forma de pagamento já definida';
    45: Result := 'Campo em branco ou contendo caracter de controle';
    47: Result := 'Nenhum periférico homologado conectado a porta auxiliar';
    48: Result := 'Valor do estorno superior ao total acumulado nesta forma de pagamento';
    49: Result := 'Forma de pagamento a ser estornada não foi encontrada na memória';
    50: Result := 'Impressora sem papel';
    61: Result := 'Operação interrompida por falta de energia elétrica';
    70: Result := 'Falha na comunicação com o módulo impressor';
    80: Result := 'Periférico conectado a porta auxiliar não homologado';
    81: Result := 'Banco não cadastrado';
    82: Result := 'Nada a imprimir';
    83: Result := 'Extenso não cabe no cheque';
    86: Result := 'Não há mais memória para o cadastro de bancos';
    87: Result := 'Impressão no verso somente após a impressão da frente do cheque';
    88: Result := 'Valor inválido para o cheque';
  end;
end;

function TECF_Daruma_FS345.Executa_Comando(xComando: string; TamanhoRetorno: Integer = 0): Boolean;
var
  buffer : string;
  msg : string;
begin
  EnviarString(#27 + xComando);
  Buffer := LerStringSufixo(35000,#13);
  msg :='';
  if buffer = '' then
    msg :='ECF não responde.';
  if (pos(':',buffer)=0) or (pos(#13,buffer)=0) then msg:='Comando Incompleto.';
  if Msg = '' then
    Msg := DecodeErros(strtointdef(copy(buffer,3,2),0),strtointdef(copy(buffer,5,2),0));
  fUltimaResposta := copy(Buffer,7,pos(#13,Buffer)-7);
  if msg <> '' then
    Result := GerarErro(Msg)
  else
    Result := True;
end;

function TECF_Daruma_FS345.GetLigada: Boolean;
begin
  Result := PortaSerial.CTS;
end;

function TECF_Daruma_FS345.LeituraX(xOperador: String):Boolean;
begin
  Result := Executa_Comando(#250);
end;

end.
